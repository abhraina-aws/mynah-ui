name: Run E2E Tests
on: workflow_call
jobs:
    build-image:
        runs-on: ubuntu-latest
        steps:
          # Checkout the PR branch
          - name: Checkout Code
            uses: actions/checkout@v4
            with:
              ref: ${{ github.head_ref }}
              fetch-depth: 0

          # Set up Docker Buildx
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3
            
          # Cache Docker layers
          - name: Cache Docker layers
            uses: actions/cache@v3
            with:
              path: /tmp/.buildx-cache
              key: ${{ runner.os }}-buildx-${{ github.sha }}
              restore-keys: |
                ${{ runner.os }}-buildx-

          # Build Docker image with caching
          - name: Build E2E tests Docker Image
            uses: docker/build-push-action@v5
            with:
              context: .
              push: false
              load: true
              tags: mynah-ui-e2e:latest
              cache-from: type=local,src=/tmp/.buildx-cache
              cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
              build-args: |
                BUILDKIT_INLINE_CACHE=1

          # Move cache to prevent unlimited growth
          - name: Move cache
            run: |
              rm -rf /tmp/.buildx-cache
              mv /tmp/.buildx-cache-new /tmp/.buildx-cache

          # Save the image as a tar file
          - name: Save Docker image
            run: docker save mynah-ui-e2e:latest > mynah-ui-e2e.tar
            
          # Upload the image as an artifact
          - name: Upload Docker image
            uses: actions/upload-artifact@v4
            with:
              name: docker-image
              path: mynah-ui-e2e.tar
              retention-days: 30

    chromium:
        needs: build-image
        uses: ./.github/workflows/e2e_chromium.yml
        
    webkit:
        needs: build-image
        uses: ./.github/workflows/e2e_webkit.yml
    
    report:
      needs: [chromium, webkit]
      if: always()
      uses: ./.github/workflows/test_report.yml
